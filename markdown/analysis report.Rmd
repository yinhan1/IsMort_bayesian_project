---
title: "Analysis Report -- Cox regression model"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::html_document2:
    number_sections: no
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
header-includes:
- \usepackage{graphicx}
- \usepackage{float}
editor_options:
  chunk_output_type: inline
---

```{r setup knit, include=FALSE}
knitr::opts_chunk$set(
	fig.align = "center",
	fig.pos = "H",
	message = FALSE,
	warning = FALSE,
	external = TRUE,
	echo = TRUE
)

library(tidyverse)
library(data.table)
library(magrittr)
library(ggsci)
library(kableExtra)

source("../scripts/functions.R")
```

## Raw data

```{r clean raw data}
is_data <- readxl::read_excel("../data/IS_data.xlsx") %>% clean_data(cols_to_numeric = c("Day after spray","Deaths"))
```

```{r plot raw data}
is_data %>% 
  get_survival_percent() %>% 
  plot_survival_percent() +
  xlim(10, 100)
```

## Model {.tabset}

### ACO

```{r}
posterior_dist <- read.csv("../data/posterior_aco.csv")[-1,] %>% burn_n_thin_draws(jump = 200, burn_at = 8000)

par(mfrow=c(4,3)) 
apply(posterior_dist, 2, function(c) acf(c))
```


```{r}
posterior_dist %>% 
  mutate(iter = c(1:nrow(posterior_dist))) %>% 
  reshape2::melt(id.vars = "iter") %>% 
  ggplot(aes(x = iter, y = value)) +
  geom_point(size = 0.07, color = "grey40") + 
  geom_line(size = 0.05) + 
  facet_wrap(~variable, ncol = 3, scales = "free_y") +
  theme_minimal()

apply(posterior_dist, 2, function(c) (quantile(c, probs = c(0.025, 0.5, 0.975))))
```

```{r calculate aco survival function}
max_day <- 47
aco_subgroups <- is_data %>% filter(Population == "ACO") %>% dummy_aco() %>% dplyr::select(-Day) %>% unique()

aco_survival <- 
  apply(aco_subgroups, 1, function(row) survival_interval_calculator(posterior_dist, x_fit = row, max_day = max_day)) %>% 
  data.frame() %>% 
  add_initial(aco_subgroups, max_day = max_day) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back(age_14, age_28)) %>% 
  select(Treatment, Sex, Age, Day, est, lower, upper)
```


```{r plot aco survival function}
aco_survival %>% plot_survival(color = "brown3")
```





### CO

```{r}
posterior_dist <- read.csv("../data/posterior_co.csv")[-1,] %>% burn_n_thin_draws(jump = 350, burn_at = 1)

par(mfrow=c(1,2)) 
apply(posterior_dist[,c(1:2)], 2, function(c) acf(c))
```

```{r}
par(mfrow=c(4,5)) 
apply(posterior_dist[,-c(1:2)], 2, function(c) acf(c))
```


```{r}
posterior_dist %>% 
  mutate(iter = c(1:nrow(posterior_dist))) %>% 
  reshape2::melt(id.vars = "iter") %>% 
  ggplot(aes(x = iter, y = value)) +
  geom_point(size = 0.07, color = "grey40") + 
  geom_line(size = 0.05) + 
  facet_wrap(~variable, ncol = 3, scales = "free_y") +
  theme_minimal()

apply(posterior_dist, 2, function(c) (quantile(c, probs = c(0.025, 0.5, 0.975))))
```

```{r calculate co survival function}
max_day <- 120
co_subgroups <- is_data %>% filter(Population == "CO") %>% dummy_co() %>% dplyr::select(-Day) %>% unique()

co_survival <- 
  apply(co_subgroups, 1, 
        function(row) survival_interval_calculator(posterior_dist, x_fit = row, max_day = max_day)) %>% 
  data.frame() %>% 
  add_initial(co_subgroups, max_day = max_day) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back2(age_14, age_28, age_42, age_56)) %>% 
  select(Treatment, Sex, Age, Day, est, lower, upper)
```


```{r plot co survival function}
co_survival %>% plot_survival(color = "grey30")
```

