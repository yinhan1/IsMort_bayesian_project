---
title: "Analysis Report -- Cox regression model"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::html_document2:
    number_sections: no
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
header-includes:
- \usepackage{graphicx}
- \usepackage{float}
editor_options:
  chunk_output_type: inline
---

```{r setup knit, include=FALSE}
knitr::opts_chunk$set(
	fig.align = "center",
	fig.pos = "H",
	message = FALSE,
	warning = FALSE,
	external = TRUE,
	echo = TRUE
)

library(tidyverse)
library(data.table)
library(magrittr)
library(ggsci)
library(kableExtra)

source("../scripts/functions.R")
```

## Control vs Uninfected {.tabset}

### Raw data

```{r}
cols_to_numeric = c("Day after spray","Deaths")
is_data <- readxl::read_excel("../data/IS_data.xlsx") %>% 
      mutate_all(function(x) as.factor(x)) %>% 
      mutate_at(cols_to_numeric, function(x) as.numeric(as.character(x))) %>% 
      mutate(Sex = recode(Sex, "F" = "Female", "M" = "Male")) %>% 
      filter(`Age at spray`==14 & Treatment != "Infected") %>% 
      droplevels() %>% 
      setnames(old = c("Age at spray", "Day after spray"),
               new = c("Age","Day"))

is_dummy <- is_data %>% 
  mutate(intercept = 1,
         control = ifelse(Treatment=="Control", 1, 0),
         female = ifelse(Sex=="Female", 1, 0),
         pop_aco = ifelse(Population == "ACO", 1, 0),
         con_female = control*female,
         con_aco = control*pop_aco,
         female_aco = female*pop_aco,
         con_female_aco = control*female*pop_aco) %>% 
  select(Day,intercept, pop_aco, control, female, con_female, con_aco, female_aco, con_female_aco)
```

```{r}
is_data %>% get_survival_percent() %>% 
  ggplot(aes(x = Day, y = Percent, linetype = Treatment, color = interaction(Population,Sex))) +
  geom_line() +
  xlim(0,85) +
  theme_minimal()
```

### Model 

```{r}
posterior_dist <- read.csv("../data/posterior_control_2020-04-13.csv") %>% burn_n_thin_draws(jump = 80, burn_at = 1)
posterior_dist %>% 
  mutate(iter = c(1:nrow(posterior_dist))) %>% 
  reshape2::melt(id.vars = "iter") %>% 
  ggplot(aes(x = iter, y = value)) +
  geom_point(size = 0.07, color = "grey40") + 
  geom_line(size = 0.05) + 
  facet_wrap(~variable, ncol = 3, scales = "free_y") +
  theme_minimal()
```

```{r control survival function}
max_day <- 85
subgroups <- is_dummy %>% dplyr::select(-Day) %>% unique()

control_survival <- 
  apply(subgroups, 1, function(row) survival_interval_calculator(posterior_dist, x_fit = row, max_day = max_day)) %>%
  data.frame() %>% 
  add_survival_initial(subgroups, max_day = max_day) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(control == 1, "Control", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Population = ifelse(pop_aco == 1, "ACO", "CO")) %>% 
  select(Treatment, Sex, Population, Day, est, lower, upper)

control_survival %>% 
  ggplot(aes(x = Day, y = est, ymin = lower, ymax = upper, 
             color = interaction(Population,Sex), linetype = Treatment)) +
  geom_line() +
  geom_errorbar() +
  xlim(0,85) +
  theme_minimal()
```

```{r control hazard rate}
control_hazard = NULL
for(i in 1:nrow(subgroups)){
    control_hazard = rbind(control_hazard, hazard_interval_calculator(posterior_dist, subgroups[i,], max_day))
}

control_hazard = 
  control_hazard %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(control == 1, "Control", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Population = ifelse(pop_aco == 1, "ACO", "CO")) %>% 
  select(Treatment, Sex, Population, Day, est, lower, upper)

control_hazard %>% 
  ggplot(aes(x = Day, y = est, ymin = lower, ymax = upper, 
             color = interaction(Population,Sex), linetype = Treatment)) +
  geom_line() +
  geom_errorbar() +
  xlim(0,85) +
  facet_grid(~Sex) +
  theme_minimal()

control_hazard %>% 
  ggplot(aes(x = Day, y = est, ymin = lower, ymax = upper, 
             color = Sex, linetype = Treatment)) +
  geom_line() +
  geom_errorbar() +
  xlim(0,85) +
  facet_grid(~Population) +
  theme_minimal()
```

```{r}
get_rate = function(subset){
  control = subset %>% unique() %>% filter(Treatment=="Control")
  uninf = subset %>% unique() %>% filter(Treatment=="Uninfected")
  cut_day = min(nrow(control),nrow(uninf))
  control = control[1:cut_day,]
  uninf = uninf[1:cut_day,]
  data.frame(Day = c(2:(cut_day+1)),
             ratio = control$est / uninf$est,
             )
}

aco_female = control_hazard %>% filter(Population=="ACO" && Sex=="Female") %>% get_rate() %>% mutate(label = "aco female")
aco_male = control_hazard %>% filter(Population=="ACO" && Sex=="Male") %>% get_rate() %>% mutate(label = "aco male")
co_female = control_hazard %>% filter(Population=="CO" && Sex=="Female") %>% get_rate() %>% mutate(label = "co female")
co_male = control_hazard %>% filter(Population=="CO" && Sex=="Male") %>% get_rate() %>% mutate(label = "co male")


rbind(aco_female,
      co_female,
      aco_male,
      co_male) %>% 
  mutate(label = factor(label, levels = c("aco female","co female","aco male","co male"))) %>% 
  ggplot(aes(x = Day, y = ratio, color = label)) +
  geom_line()
```


## Infected vs Uninfected {.tabset}

### Raw data

```{r import and plot raw data}
is_data <- readxl::read_excel("../data/IS_data.xlsx") %>% clean_data(cols_to_numeric = c("Day after spray","Deaths"))
is_data %>% get_survival_percent() %>% plot_survival_percent() + xlim(10, 100)
```

### ACO {.tabset}

```{r thin aco posterior draws}
posterior_dist <- read.csv("../data/posterior_aco.csv")[-1,] %>% burn_n_thin_draws(jump = 200, burn_at = 8000)

par(mfrow=c(4,3)) 
apply(posterior_dist, 2, function(c) acf(c))
```

```{r track aco posterior draws}
posterior_dist %>% 
  mutate(iter = c(1:nrow(posterior_dist))) %>% 
  reshape2::melt(id.vars = "iter") %>% 
  ggplot(aes(x = iter, y = value)) +
  geom_point(size = 0.07, color = "grey40") + 
  geom_line(size = 0.05) + 
  facet_wrap(~variable, ncol = 3, scales = "free_y") +
  theme_minimal()

apply(posterior_dist, 2, function(c) (quantile(c, probs = c(0.025, 0.5, 0.975))))
```

```{r aco survival function}
max_day <- 47
aco_subgroups <- is_data %>% filter(Population == "ACO") %>% dummy_aco() %>% dplyr::select(-Day) %>% unique()

aco_survival <- 
  apply(aco_subgroups, 1, function(row) survival_interval_calculator(posterior_dist, x_fit = row, max_day = max_day)) %>%
  data.frame() %>% 
  add_survival_initial(aco_subgroups, max_day = max_day) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back(age_14, age_28)) %>% 
  select(Treatment, Sex, Age, Day, est, lower, upper)

aco_survival %>% plot_survival(color = "brown3")
```

```{r aco median life}
aco_median <- 
  apply(aco_subgroups, 1, function(row) median_calculator(posterior_dist, row)) %>% 
  median_intervals_calculator() %>% 
  t() %>% 
  set_colnames(c("lower","est","upper")) %>% 
  cbind(aco_subgroups,.) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back(age_14, age_28)) %>% 
  select(Treatment, Sex, Age, est, lower, upper)

aco_median %>% 
  ggplot(aes(x = as.character(Age), y = est, fill = Treatment)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  geom_text(aes(label = round(est,2)), vjust = 2.5, size = 3, position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.3, color = "grey40", alpha = 0.5,
                position = position_dodge(0.9)) +
  facet_grid(~Sex) +
  scale_fill_brewer(palette="Reds") +
  theme_minimal() +
  labs(x = "Age", y = "Median life")
```

```{r aco median residual life}
max_day <- 46
aco_subgroups <- is_data %>% filter(Population == "ACO") %>% dummy_aco() %>% dplyr::select(-Day) %>% unique()

aco_median_residual <- 
  apply(
    aco_subgroups, 1, 
    function(row) median_residual_interval_calculator(posterior_dist, x_fit = row, max_day = max_day)) %>%
  data.frame() %>%
  add_median_residual_initial(aco_subgroups, max_day = max_day) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back(age_14, age_28)) %>% 
  select(Treatment, Sex, Age, Day, est, lower, upper) %>% 
  filter(est >= 1)

aco_median_residual %>% filter(Treatment == "Uninfected") %>% plot_median_residual(type = 1)
aco_median_residual %>% filter(Treatment == "Infected") %>% plot_median_residual(type = 2)
```


```{r}
aco_median_slope <- 
  aco_median_residual %>% 
  group_by(Treatment,Age,Sex) %>% 
  mutate(est = c(NA,diff(est)),
         lower = c(NA,diff(lower)),
         upper = c(NA,diff(upper))) %>% 
  na.omit()

aco_median_slope %>% filter(Treatment == "Uninfected") %>% plot_median_residual_slope(type = 2)
aco_median_slope %>% filter(Treatment == "Infected") %>% plot_median_residual_slope(type = 2)
```

```{r aco change of scale}
# age 14 measurement 0.06368858
exp(-0.608 -0.62447)/exp(1.809 -0.608+0.945-0.62472)
# age 28 measurement 0.1171852
exp(-0.608 -0.200)/exp(1.809 -0.608+0.335-0.200)
# age 42 measurement 1 
exp(-0.608 - 0)/exp(-0.608)
```

```{r aco abs scale inf}
exp(1.809 -0.608+0.945-0.62472)  # 4.578081
exp(1.809 -0.608+0.335-0.200)    # 3.803798
exp(-0.608)                      # 0.5444387
```


```{r aco hazard rate}
control_hazard = NULL
for(i in 1:nrow(aco_subgroups)){
    control_hazard = rbind(control_hazard, hazard_interval_calculator(posterior_dist, aco_subgroups[i,], max_day))
}

control_hazard = 
  control_hazard %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back(age_14, age_28)) %>% 
  select(Treatment, Sex, Age, Day, est, lower, upper)

control_hazard %>% 
  ggplot(aes(x = Day, y = est, ymin = lower, ymax = upper, 
             color = Sex, linetype = Treatment)) +
  geom_line() +
  geom_errorbar() +
  xlim(0,85) +
  facet_grid(~Age) +
  theme_minimal()
```


```{r}
get_rate = function(subset){
  female = subset %>% unique() %>% filter(Sex =="Female")
  male = subset %>% unique() %>% filter(Sex == "Male")
  cut_day = min(nrow(female),nrow(male))
  female = female[1:cut_day,]
  male = male[1:cut_day,]
  data.frame(Day = c(2:(cut_day+1)),
             ratio = male$est / female$est
             )
}

inf_14 = control_hazard %>% filter(Treatment == "Infected" && Age == 14) %>% get_rate() %>% mutate(label = "infected 14")
unf_14 = control_hazard %>% filter(Treatment == "Uninfected" && Age == 14) %>% get_rate() %>% mutate(label = "uninfected 14")
inf_28 = control_hazard %>% filter(Treatment == "Infected" && Age == 28) %>% get_rate() %>% mutate(label = "infected 28")
unf_28 = control_hazard %>% filter(Treatment == "Uninfected" && Age == 28) %>% get_rate() %>% mutate(label = "uninfected 28")


rbind(inf_14,unf_14,inf_28,unf_28) %>% 
  ggplot(aes(x = Day, y = ratio, color = label)) +
  geom_line()
```
```






### CO {.tabset}

```{r thin co posterior draws}
posterior_dist <- read.csv("../data/posterior_co.csv")[-1,] %>% burn_n_thin_draws(jump = 350, burn_at = 1)

par(mfrow=c(1,2)) 
apply(posterior_dist[,c(1:2)], 2, function(c) acf(c))

par(mfrow=c(4,5)) 
apply(posterior_dist[,-c(1:2)], 2, function(c) acf(c))
```


```{r track co posterior draws}
posterior_dist %>% 
  mutate(iter = c(1:nrow(posterior_dist))) %>% 
  reshape2::melt(id.vars = "iter") %>% 
  ggplot(aes(x = iter, y = value)) +
  geom_point(size = 0.07, color = "grey40") + 
  geom_line(size = 0.05) + 
  facet_wrap(~variable, ncol = 3, scales = "free_y") +
  theme_minimal()

apply(posterior_dist, 2, function(c) (quantile(c, probs = c(0.025, 0.5, 0.975)))) %>% t()
```

```{r co survival function}
max_day <- 120
co_subgroups <- is_data %>% filter(Population == "CO") %>% dummy_co() %>% dplyr::select(-Day) %>% unique()

co_survival <- 
  apply(co_subgroups, 1, 
        function(row) survival_interval_calculator(posterior_dist, x_fit = row, max_day = max_day)) %>% 
  data.frame() %>% 
  add_survival_initial(co_subgroups, max_day = max_day) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back2(age_14, age_28, age_42, age_56)) %>% 
  select(Treatment, Sex, Age, Day, est, lower, upper)

co_survival %>% plot_survival(color = "grey30")
```


```{r co median life}
co_median <- 
  apply(co_subgroups, 1, function(row) median_residual_calculator(posterior_dist, row)) %>% 
  residual_intervals_calculator() %>% 
  t() %>% 
  set_colnames(c("lower","est","upper")) %>% 
  cbind(co_subgroups,.) %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back2(age_14, age_28, age_42, age_56)) %>% 
  select(Treatment, Sex, Age, est, lower, upper)

co_median %>% 
  ggplot(aes(x = as.character(Age), y = est, fill = Treatment)) +
  geom_bar(stat = "identity", position=position_dodge()) +
  geom_text(aes(label = round(est,2)), vjust = 2.5, size = 3, position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.3, color = "grey40", alpha = 0.5,
                position = position_dodge(0.9)) +
  facet_grid(~Sex) +
  scale_fill_brewer(palette="Greys") +
  theme_minimal() +
  labs(x = "Age", y = "Median life")
```


```{r co hazard rate}
control_hazard = NULL
for(i in 1:nrow(co_subgroups)){
    control_hazard = rbind(control_hazard, hazard_interval_calculator(posterior_dist, co_subgroups[i,], max_day))
}

control_hazard = 
  control_hazard %>% 
  rowwise() %>% 
  mutate(Treatment = ifelse(infected == 1, "Infected", "Uninfected"),
         Sex = ifelse(female == 1, "Female", "Male"),
         Age = convert_age_back2(age_14, age_28, age_42, age_56)) %>% 
  select(Treatment, Sex, Age, Day, est, lower, upper)

control_hazard %>% 
  ggplot(aes(x = Day, y = est, ymin = lower, ymax = upper, 
             color = Sex, linetype = Treatment)) +
  geom_line() +
  geom_errorbar() +
  xlim(0,85) +
  facet_grid(~Age) +
  theme_minimal()
```






